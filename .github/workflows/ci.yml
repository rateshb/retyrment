name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  backend-test:
    name: Backend Tests + Coverage
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Run backend tests with coverage
        working-directory: backend
        run: mvn -B clean test jacoco:report
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/retyrment_test
          APP_JWT_SECRET: test-secret-key-for-jwt-tokens-must-be-at-least-256-bits-long-for-testing-purposes
          APP_FRONTEND_URL: http://localhost:3000
      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: |
            backend/target/site/jacoco/jacoco.xml
            backend/target/jacoco.exec
            backend/target/surefire-reports/

  frontend-test:
    name: Frontend Tests + Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend-react/package.json
      - name: Install dependencies
        working-directory: frontend-react
        run: npm install
      - name: Run frontend tests with coverage
        working-directory: frontend-react
        run: npm run test:ci
      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend-react/coverage/lcov.info

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend/target/
      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend-react/coverage/
      - name: Set SonarCloud project key
        id: sonar
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "projectKey=${{ github.repository_owner }}_${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "organization=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=${{ steps.sonar.outputs.organization }}
            -Dsonar.projectKey=${{ steps.sonar.outputs.projectKey }}
            -Dsonar.sources=backend/src/main/java,frontend-react/src
            -Dsonar.tests=backend/src/test/java
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*Test.java
            -Dsonar.java.binaries=backend/target/classes
            -Dsonar.coverage.jacoco.xmlReportPaths=backend/target/site/jacoco/jacoco.xml
            -Dsonar.javascript.lcov.reportPaths=frontend-react/coverage/lcov.info
            -Dsonar.coverage.exclusions=**/model/**,**/security/**,**/exception/**,**/config/**,**/RetyrmentApplication.java
